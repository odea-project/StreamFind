---
title: 'Fusion of Mass Spectrometry and Raman Spectroscopy Data'
subtitle: |
  | Comparison of paracetamol deviations
  | <br>
author:
  name: Ricardo Cunha
  email: cunha@iuta.de
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: true
    toc: true
    number_sections: true
    toc_float: true
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Fusion of Mass Spectrometry and Raman Spectroscopy Data}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(magrittr)
library(ggplot2)
library(plotly)
library(data.table)
library(StreamFind)

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 9, results = "asis", comment = "")

main_dir <- "C:/Users/apoli/Documents/iSoft/Paracetamol"

ms_dir <- paste0(main_dir, "/ms/mzml")

ms_files <- list.files(ms_dir, pattern = ".mzML", full.names = TRUE)

raman_dir <- paste0(main_dir, "/raman")

raman_files <- list.files(raman_dir, pattern = ".asc", full.names = TRUE)
```

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<br>

<br>

***

# Introduction

# Pre-processing

## MS

```{r}
ms <- MassSpecEngine$new(files = ms_files, headers = list(name = "BSA Quality Evaluation Project"))

ms$add_replicate_names(
  c(rep("fiz1_1", 3),
    rep("fiz1_2", 3),
    rep("fiz1_3", 3),
    rep("fiz2_1", 3),
    rep("fiz2_2", 3),
    rep("fiz2_3", 3),
    rep("fiz3_1", 3),
    rep("fiz3_2", 3),
    rep("fiz3_3", 3),
    rep("fiz_caff_1", 3),
    rep("fiz_caff_2", 3),
    rep("fiz_caff_3", 3),
    rep("fiz_ass_1", 3),
    rep("fiz_ass_2", 3),
    rep("fiz_ass_3", 3),
    rep("fiz4_1", 3),
    rep("fiz4_2", 3),
    rep("fiz4_3", 3),
    rep("fiz_acid_1", 3),
    rep("fiz_acid_2", 3),
    rep("fiz_acid_3", 3),
    rep("ass_n_1", 3),
    rep("ass_n_2", 3),
    rep("ass_n_3", 3),
    rep("ass_1", 3),
    rep("ass_2", 3),
    rep("ass_3", 3),
    rep("caff_1", 3),
    rep("caff_2", 3),
    rep("caff_3", 3),
    rep("par_1", 3),
    rep("par_2", 3),
    rep("par_3", 3),
    rep("blank", 23)
  )
)

# View(ms$get_overview())
```

```{r, fig.cap="Total ion chromatograms for each analysis replicate."}
# ms$plot_spectra_tic(colorBy = "replicates")

# only blanks
# ms$plot_spectra_tic(analyses = 100:122, colorBy = "analyses")
```

```{r}
ms <- ms$subset_analyses(analyses = c(1:63, 73:99, 118:121))
ms$add_blank_names(rep("blank", 94))
ms$load_spectra()
```

```{r}
ms_workflow_settings <- list(
  Settings_bin_spectra_StreamFind(bins = list("rt" = 5, "mz" = 2), refBinAnalysis = 1),
  Settings_normalize_spectra_minmax(),
  Settings_average_spectra_StreamFind(),
  Settings_subtract_blank_spectra_StreamFind(negativeToZero = TRUE),
  Settings_normalize_spectra_blockweight()
)

ms$add_settings(ms_workflow_settings)

ms$print_workflow()
```

```{r}
ms$run_workflow()
```

```{r ,fig.cap="Deconvoluted and pre-processed spectra for each analysis."}
ms$plot_spectra()
```

## Raman

```{r}
raman <- RamanEngine$new(raman_files)

raman$add_replicate_names(
  c(
    rep("ass_1", 3),
    rep("ass_2", 3),
    rep("ass_3", 3),
    rep("caff_1", 3),
    rep("caff_2", 3),
    rep("caff_3", 3),
    rep("blank", 9),
    rep("fiz3_1", 3),
    rep("fiz3_2", 3),
    rep("fiz3_3", 3),
    rep("fiz_ass_n_1", 3),
    rep("fiz_ass_n_2", 3),
    rep("fiz_ass_n_3", 3),
    rep("fiz_ass_1", 3),
    rep("fiz_ass_2", 3),
    rep("fiz_ass_3", 3),
    rep("fiz_caff_1", 3),
    rep("fiz_caff_2", 3),
    rep("fiz_caff_3", 3),
    rep("fiz1_1", 3),
    rep("fiz1_2", 3),
    rep("fiz1_3", 3),
    rep("fiz4_1", 3),
    rep("fiz4_2", 3),
    rep("fiz4_3", 3),
    rep("fiz2_1", 3),
    rep("fiz2_2", 3),
    rep("fiz2_3", 3),
    rep("background", 4),
    rep("fiz_acid_1", 3),
    rep("fiz_acid_2", 3),
    rep("fiz_acid_3", 3),
    rep("par_1", 3),
    rep("par_odd", 3),
    rep("par_3", 3),
    rep("par_2", 3),
    rep("cali_150_mgml", 9),
    rep("cali_010_mgml", 9),
    rep("cali_025_mgml", 9),
    rep("cali_050_mgml", 9),
    rep("cali_075_mgml", 9),
    rep("background", 4)
  )
)

# View(raman$get_overview())
```

```{r ,fig.cap="Raw averaged Raman spectra for each BSA product between minute 5.5 and 8."}
# raman$plot_spectra(colorBy = "replicates")
```

```{r}
raman <- raman$subset_analyses(analyses = c(1:36, 46:90, 95:106, 110:115))
raman$add_blank_names(rep("blank", 99))
raman$plot_spectra(colorBy = "replicates")
```

```{r}
raman_workflow_settings <- list(
  Settings_average_spectra_StreamFind(),
  Settings_subtract_blank_spectra_StreamFind(),
  Settings_smooth_spectra_savgol(fl = 21, forder = 4, dorder = 0),
  Settings_delete_spectra_section_StreamFind(list("shift" = c(-100, 350))),
  Settings_delete_spectra_section_StreamFind(list("shift" = c(1800, 2500))),
  Settings_correct_spectra_baseline_airpls(lambda = 45, differences = 1, itermax = 30),
  Settings_normalize_spectra_minmax(),
  Settings_normalize_spectra_blockweight()
)

raman$add_settings(raman_workflow_settings)

raman$print_workflow()
```

```{r}
raman$run_workflow()
```

```{r ,fig.cap="Processed Raman spectra for each BSA product."}
raman$plot_spectra()
```

# Fusion

```{r}
rSpec <- raman$get_spectra()
rSpec <- rSpec[order(rSpec$replicate), ]
mrSpec <- matrix(rSpec$intensity, nrow = length(unique(rSpec$replicate)), ncol = length(unique(rSpec$shift)), byrow = TRUE, dimnames = list(as.character(unique(rSpec$replicate)), as.character(round(unique(rSpec$shift), digits = 1))))

mSpec <- ms2$get_spectra()
mSpec <- mSpec[order(mSpec$replicate), ]
mmSpec <- matrix(mSpec$intensity, nrow = length(unique(mSpec$replicate)), ncol = length(unique(mSpec$bins)), byrow = TRUE, dimnames = list(unique(mSpec$replicate), unique(mSpec$bins)))

fusedMat <- cbind(mmSpec, mrSpec)


# stat <- StatisticEngine$new(data = fusedMat)
# stat$make_pca_model(Settings_make_pca_model_mdatools(center = TRUE, ncomp = 3))
# stat$plot_model_scores()
# stat$plot_model_loadings()
# stat$plot_model_residuals()
# subset matrix for 1 row but keep matrix not vector

attr(fusedMat, "xaxis.name") = "Keys"
attr(fusedMat, "xaxis.values") = seq_len(ncol(fusedMat))

# Mean centering improves separation but can we do it?
library(mdatools)
fusedMat = prep.autoscale(fusedMat, center = TRUE, scale = FALSE)
```

```{r}
cl <- StreamFind:::.get_colors(rownames(fusedMat))
fig <- plot_ly()
xVal <- seq_len(length(fusedMat[1, ]))
for (i in seq_len(nrow(fusedMat))) {
  fig <- fig %>% add_trace(
    x = xVal,
    y = fusedMat[i, ],
    type = "scatter", mode = "lines",
    line = list(width = 0.5, color = unname(cl[i])),
    name = names(cl)[i],
    legendgroup = names(cl)[i],
    showlegend = TRUE
  )
}
xaxis <- list(
  linecolor = toRGB("black"),
  linewidth = 2, title = "Bins",
  titlefont = list(size = 12, color = "black")
)
yaxis <- list(
  linecolor = toRGB("black"),
  linewidth = 2, title = "Intensity",
  titlefont = list(size = 12, color = "black")
)
fig <- fig %>% plotly::layout(xaxis = xaxis, yaxis = yaxis)
fig
```

# Statistic analysis

## Overall PCA

```{r, include=FALSE}
library(mdatools)
m = pca(fusedMat, 3, center = FALSE, scale = FALSE, info = "Overall PCA model")
```

```{r ,echo=FALSE,fig.width=10,fig.height=4}
library(plotly)

cl <- StreamFind:::.get_colors(rownames(fusedMat))
scores_polt <- plot_ly()

scores_polt <- scores_polt %>% add_trace(
  x = m$res$cal$scores[, "Comp 1"],
  y = m$res$cal$scores[, "Comp 2"],
  type = "scatter",
  mode = "markers+text",
  color = names(cl),
  colors = cl,
  text = rownames(m$res$cal$scores),
  textfont = list(size = 14, color = cl),
  textposition = "top",
  marker = list(size = 10, color = cl),
  showlegend = FALSE
)

scores_polt <- scores_polt %>% layout(
  xaxis = list(title = "Principal Component 1"),
  yaxis = list(title = "Principal Component 2")
)

cl2 <- StreamFind:::.get_colors(1:2)
loadings_plot <- plot_ly()

loadings_plot <- loadings_plot %>% add_trace(
  x = m$loadings[rownames(m$loadings) %in% colnames(mrSpec), "Comp 1"],
  y = m$loadings[rownames(m$loadings) %in% colnames(mrSpec), "Comp 2"],
  type = "scatter",
  mode = "markers+text",
  text = rownames(m$loadings)[(rownames(m$loadings) %in% colnames(mrSpec))],
  textfont = list(size = 14, color = cl2[1]),
  textposition = "top",
  legendgroup = "Raman",
  name = "Raman",
  marker = list(size = 10, color = cl2[1])
)
 
loadings_plot <- loadings_plot %>% add_trace(
  x = m$loadings[rownames(m$loadings) %in% colnames(mmSpec), "Comp 1"],
  y = m$loadings[rownames(m$loadings) %in% colnames(mmSpec), "Comp 2"],
  type = "scatter",
  mode = "markers+text",
  text = rownames(m$loadings)[(rownames(m$loadings) %in% colnames(mmSpec))],
  textfont = list(size = 14, color = cl2[2]),
  textposition = "top",
  legendgroup = "MS",
  name = "MS",
  marker = list(size = 10, color = cl2[2])
)

loadings_plot <- loadings_plot %>% layout(
  xaxis = list(title = "Principal Component 1"),
  yaxis = list(title = "Principal Component 2")
)

subplot(
  scores_polt, loadings_plot, nrows = 1,
  shareX = FALSE, shareY = FALSE, titleX = TRUE, titleY = TRUE,
  margin = 0.1
)
```

## Unsupervised

Using Principle Components Analysis (PCA) for unsupervised evaluation.

```{r}
library(mdatools)
# rownames(fusedMat)
main_set <- fusedMat[c(14:15, 18), ]
test_set <- fusedMat[c(1:13, 16:17, 19:30), ]

m3 = pca(main_set, 3, center = FALSE, scale = FALSE, info = "Unsupervised PCA model", alpha = 1E-1, gamma = 1E-2)

plot(m3)

res = predict(m3, test_set)

plot(res)

c = categorize(m3, res)

names(c) <- rownames(test_set)

plotResiduals(m3,
  ncomp = 2,
  res = list("train" = m3$res$cal, "new" = res),
  norm = TRUE, show.labels = TRUE,
  lim.col = c("red", "orange"), lim.lwd = c(2, 2), lim.lty = c(1, 2)
)

plotResiduals(res, show.plot = FALSE, norm = TRUE)



print(c)

is(m3$res$cal, "ldecomp")

stat <- StatisticEngine$new(data = main_set)
stat$make_pca_model(Settings_make_pca_model_mdatools(center = FALSE, ncomp = 3, alpha = 1E-1, gamma = 1E-2))
stat$predict(test_set)

stat$plot_predicted_distances()





```

## Supervised (classification)

Using k-nearest neighbors (KNN) for classification.

```{r}
train_set <- fusedMat[c(grep("_1", rownames(fusedMat)), grep("_2", rownames(fusedMat))), ]

train_set <- train_set[order(rownames(train_set)), ]

test_set <- fusedMat[grep("_3", rownames(fusedMat)), ]

labels <- factor(c(rep("ass", 2), rep("caff", 2), rep("fiz_acid", 2), rep("fiz_ass", 2), rep("fiz_caff", 2),
  rep("fiz_altered", 2), rep("fiz_altered", 2), rep("fiz", 2), rep("fiz", 2), rep("par", 2))
)

library(class)

knn_model <- knn(train = train_set, test = test_set, cl = labels, k = 3, prob = FALSE)

names(knn_model) <- rownames(test_set)

data.frame(class = knn_model)
# print(knn_model)
```

## Other

Using Hierarchical Clustering.

```{r}
hc_result <- hclust(dist(fusedMat), method = "ward.D2")
plot(hc_result)
```



