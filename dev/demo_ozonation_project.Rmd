---
title: 'StreamFind: Wastewater Ozonation'
subtitle: Mass spectrometry project example
author:
  name: Ricardo Cunha
  email: cunha@iuta.de
  affiliation: "Institut f√ºr Umwelt & Energie, Technik & Analytik e. V. (IUTA) <br> Bliersheimer Str. 58 - 60, 47229 Duisburg"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    theme: paper
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

# Libraries
library(knitr)
library(kableExtra)
library(magrittr)
library(ggplot2)
library(plotly)
library(StreamFind)

# Variables
logo <- NA_character_

# Global options
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", fig.width = 9, results = "asis")

# Working directory
path_wd <- getwd()

# Add logo file
path_extdata <- system.file(package = "StreamFindData", dir = "extdata")
logo <- file.path(path_extdata, "logo_StreamFind.png") #207 x 216 px
```

```{r logo, echo=FALSE}
if (!is.na(logo)) {
  htmltools::img(
  src = knitr::image_uri(logo),
  alt = "logo",
  style =
    paste0("
      margin-left:inherit;
      position:absolute;
      top:100px;
      left:610px;
      width:", 250, "px;
      height:", 250*(1633/3070), "px;"
    )
  ) 
} # height:", 100*(216/207), "px;"
```

<br>

```{r resources, include=FALSE}
# MS files
all_files <- StreamFindData::get_all_file_paths()
files <- all_files[grepl("blank|influent|o3sw", all_files)]

# Chemicals database
db <- StreamFindData::get_tof_spiked_chemicals()
db <- db[grepl("S", db$tag), ]
cols <- c("name", "formula", "mass", "rt", "tag")
db <- db[, cols, with = FALSE]
db
```


***

# Create a *MassSpecData*

An [R6](https://r6.r-lib.org/) [MassSpecData](https://odea-project.github.io/StreamFind/reference/MassSpecData.html) class object is created using the `MassSpecData$new()`, as shown below for a set of *mzML* files. The original vendor files were converted to *mzML* format using the [convert_ms_files](https://odea-project.github.io/StreamFind/reference/convert_ms_files.html) function, which uses the *msConvert* command line from [ProteoWizard](https://proteowizard.sourceforge.io/download.html). The files are from influent and effluent of a wastewater ozonation step measured in positive and negative ionization mode. Blank measurements for each ionization were also included for background subtraction.

```{r files, results='markup'}
basename(files)
```

```{r create-ms, message=FALSE, warning=FALSE}
# Create a MassSpecData from mzML files
ms <- MassSpecData$new(files = files)
```

```{r show-ms, results='markup'}
# Print in console a summary of the MassSpecData
ms
```

## Add *ProjectHeaders*

Project headers (e.g., name, author and description) can be added to the MassSpecData as shown below. The headers are converted to an S3 [ProjectHeaders](https://odea-project.github.io/StreamFind/reference/ProjectHeaders.html) class object.

```{r add-headers, results='markup'}
# Add headers to the MassSpecData
ms$add_headers(
  name = "Wastewater Ozonation",
  author = "Ricardo Cunha",
  description = "StreamFind demonstration project"
)

# Get the headers as ProjectHeaders
ms$get_headers()

# Get the MassSpecData name
ms$get_headers(value = "name")
```

## Associate blanks

The analysis replicate names and the associated blank replicate name can be ammended in the MassSpecData as shown below. 

```{r add-replicates, results='markup'}

# Character vector with analysis replicate names
rpls <- c(
  rep("blank_neg", 3),
  rep("blank_pos", 3),
  rep("in_neg", 3),
  rep("in_pos", 3),
  rep("out_neg", 3),
  rep("out_pos", 3)
)

# Character vector with associated blank replicate names
# Note that the order should match the respective replicate
blks <- c(
  rep("blank_neg", 3),
  rep("blank_pos", 3),
  rep("blank_neg", 3),
  rep("blank_pos", 3),
  rep("blank_neg", 3),
  rep("blank_pos", 3)
)

# Chaining add replicates and blanks
ms$add_replicate_names(rpls)$add_blank_names(blks)

# Get the blank replicate names
ms$get_blank_names()
```

# Data processing

Data processing is performed by modules according to [ProcessingSettings](https://odea-project.github.io/StreamFind/reference/ProcessingSettings.html) as shown in the following sub-chapters. 

## Obtain *ProcessingSettings*

The S3 *ProcessingSettings* class objects for processing modules are obtained via the respective [Settings](https://odea-project.github.io/StreamFind/reference/index.html#processing-settings-for-ms-data) functions. Below we obtain the *ProcessingSettings* for the module `find_features()` using the algorithm *xcms3_centwave*. The parameters for each processing module can be changed via the function arguments and the information about the meaning of each parameter can be found in the [StreamFind reference documentation](https://odea-project.github.io/StreamFind/reference/index.html).

```{r ffs, results='markup'}
# Get ProcessingSettings for finding features using the xcms3 centwave algorithm
ffs <- Settings_find_features_xcms3_centwave()

# Print in console the details of the ProcessingSettings
ffs
```

```{r other-settings, results='markup'}
fls <- Settings_filter_features_StreamFind(
  minIntensity = 5000,
  minSnRatio = 20,
  maxGroupSd = 30,
  blank = 5,
  minGroupAbundance = 3,
  excludeIsotopes = TRUE
)

fls

afs <- Settings_annotate_features_StreamFind()

afs

gfs <- Settings_group_features_xcms3_peakdensity()

gfs
```

## Add *ProcessingSettings*

When all settings are available, they can be added or used directly to run the workflow. In the example below, the different *ProcessingSettings* are first added to the *MassSpecData* in the desired order.

```{r add-settings, results='markup'}
# Add settings for finding, annotating, grouping and finally filter features
ms$add_settings(settings = list(ffs, afs, gfs, fls))

# Getting the workflow settings
ms$get_settings_names()
```

## Apply the workflow

The workflow can be run by chaining all the modules as demonstrated below or by running the method `run_workflow()`. 

```{r do-workflow, results='markup', warning=FALSE}

ms$run_workflow()

ms

#ms$find_features()$annotate_features()$group_features()$filter_features()
```



# Instructions

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents.
For more details on using R Markdown see <http://rmarkdown.rstudio.com>.
Diverse cheatsheets can be found in <https://www.rstudio.com/resources/cheatsheets/>.
This section gives quick instructions to display text, code, tables and figures.  

## Text

Text in R markdown has several inline codes for costumization.
The book in <https://bookdown.org/yihui/rmarkdown/> offers a detailed guideline.
Moreover, a cheatsheet can be downdloaded with the following link <https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf>.

## Code

Code is automaticelly embedded unless `echo` chunk option is set to `FALSE`.
Evaluation of code in a given chunk can be skiped by setting `eval` to `FALSE`.
Code chunks should always be unically named.  

```{r exampleCode}

#Example of code chunk

list(a = 1:6, b = 1:10)

```

<br>

## Tables

The `knitr::kable` function can be used for displaying tables, see table \@ref(tab:exampleTable). Consult <https://haozhu233.github.io/kableExtra/awesome_table_in_html.html> for other costumization options.
Table caption is added with the argument `caption` of the `kable` function.   

```{r exampleTable}

df <- data.frame(name = c("a", "b", "c", "d", "e", "f"), col1 = 1:6, col2 = 1:6)

knitr::kable(df, caption = "Example of table caption.") %>%
kable_styling(
  font_size = 12,
  bootstrap_options = c("striped", "hover", "condensed", "responsive"),
  fixed_thead = TRUE
) %>%
  scroll_box(width = "100%", height = "350px")

```

<br>

## Figures

Figures/plots can also by embedded using diverse packages.
The packages `ggplot2` and `plotly` (interactive) are recommended as they are versatile and easy to use.
Cheatsheet for `ggplot2` can be found in <https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-visualization.pdf>.
For `plotly` the website <https://plotly.com/r/> offers examples and a cheatsheet can be downdloaded in <https://images.plot.ly/plotly-documentation/images/r_cheat_sheet.pdf>.
Note that the `echo = FALSE` parameter can be added to the code chunk to prevent printing of the R code that generate the plots.  

### Example `ggplot2`

```{r examplePlot, fig.cap="Plot caption example"}

ggplot(pressure, aes(temperature, pressure)) +
geom_point() +
theme_bw()

```

### Example `plotly`

```{r examplePlotly, fig.cap="Plot caption example"}

plot_ly(pressure, x = ~temperature, y = ~pressure, type = "scatter", mode = "markers+lines")

```

<br> <br>

# Signature

The report was produced on `r Sys.time()`. The data and report are stored in ``r path_wd`` of the workstation *`r Sys.info()["nodename"]`* under the user *`r Sys.info()["user"]`*.

***

<br>

<style>
body, p {
  color: black;
  font-family: Arial;
  text-align: justify;
  font-size: 12pt;
}
h1{
  font-size: 20pt;
  font-style: bold;
}
h2{
  font-size:18pt;
  font-style: bold;
}
h3{
  font-size:14pt;
  font-style: bold;
}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #177013;
}
caption {
  color: black;
  font-size: 1.0em;
}
</style>
