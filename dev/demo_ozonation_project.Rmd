---
title: 'Wastewater ozonation showcase'
subtitle: |
  | Mass spectrometry project example
  | <br>
author:
  name: Ricardo Cunha
  email: cunha@iuta.de
  # affiliation: "Institut f√ºr Umwelt & Energie, Technik & Analytik e. V. (IUTA) <br> Bliersheimer Str. 58 - 60, 47229 Duisburg"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: true
    toc: true
    number_sections: true
    toc_float: true
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Developer guide for mass spectrometry}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

# Libraries
library(knitr)
library(kableExtra)
library(magrittr)
library(ggplot2)
library(plotly)
library(StreamFind)

# Variables
logo <- NA_character_

# Global options
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", fig.width = 9, results = "asis")

# Working directory
path_wd <- getwd()

# Add logo file
path_extdata <- system.file(package = "StreamFindData", dir = "extdata")
logo <- file.path(path_extdata, "logo_StreamFind.png")
# logo <- "man/figures/logo_StreamFind.png"
```

```{r logo, echo=FALSE}
if (!is.na(logo)) {
  htmltools::img(
  src = knitr::image_uri(logo),
  alt = "logo",
  style =
    paste0("
      margin-left:inherit;
      position:absolute;
      top:150px;
      left:600px;
      width:", 250, "px;
      height:", 250*(1633/3070), "px;"
    )
  )
}
```

```{r resources, include=FALSE}
# MS files
all_files <- StreamFindData::get_all_file_paths()
files <- all_files[grepl("blank|influent|o3sw", all_files)]

# Chemicals database
db <- StreamFindData::get_tof_spiked_chemicals()
db <- db[grepl("S", db$tag), ]
cols <- c("name", "formula", "mass", "rt", "tag")
db <- db[, cols, with = FALSE]
db
```

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<br>

<br>

***

# Create a *MassSpecData*

An [R6](https://r6.r-lib.org/) [MassSpecData](https://odea-project.github.io/StreamFind/reference/MassSpecData.html) class object is created using the `MassSpecData$new()`, as shown below for a set of *mzML* files. The original vendor files were converted to *mzML* format using the [convert_ms_files](https://odea-project.github.io/StreamFind/reference/convert_ms_files.html) function, which uses the *msConvert* command line from [ProteoWizard](https://proteowizard.sourceforge.io/download.html). The files are from influent and effluent of a wastewater ozonation step measured in positive and negative ionization mode. Blank measurements for each ionization were also included for background subtraction.

```{r files, results='markup'}
basename(files)
```

```{r create-ms, message=FALSE, warning=FALSE}
# Create a MassSpecData from mzML files
ms <- MassSpecData$new(files = files)
```

```{r show-ms, results='markup'}
# Print in console a summary of the MassSpecData
ms
```

## Add *ProjectHeaders*

Project headers (e.g., name, author and description) can be added to the MassSpecData as shown below. The headers are converted to an S3 [ProjectHeaders](https://odea-project.github.io/StreamFind/reference/ProjectHeaders.html) class object.

```{r add-headers, results='markup'}
# Add headers to the MassSpecData
ms$add_headers(
  name = "Wastewater Ozonation",
  author = "Ricardo Cunha",
  description = "StreamFind demonstration project"
)

# Get the headers as ProjectHeaders
ms$get_headers()

# Get the MassSpecData name
ms$get_headers(value = "name")
```

## Associate blanks

The analysis replicate names and the associated blank replicate name can be amended in the MassSpecData as shown below. 

```{r add-replicates, results='markup'}

# Character vector with analysis replicate names
rpls <- c(
  rep("blank_neg", 3),
  rep("blank_pos", 3),
  rep("in_neg", 3),
  rep("in_pos", 3),
  rep("out_neg", 3),
  rep("out_pos", 3)
)

# Character vector with associated blank replicate names
# Note that the order should match the respective replicate
blks <- c(
  rep("blank_neg", 3),
  rep("blank_pos", 3),
  rep("blank_neg", 3),
  rep("blank_pos", 3),
  rep("blank_neg", 3),
  rep("blank_pos", 3)
)

# Chaining add replicates and blanks
ms$add_replicate_names(rpls)$add_blank_names(blks)

# Get the blank replicate names
ms$get_blank_names()
```

# Data processing

Data processing is performed by modules according to [ProcessingSettings](https://odea-project.github.io/StreamFind/reference/ProcessingSettings.html) as shown in the following sub-chapters. 

## Obtain *ProcessingSettings*

The S3 *ProcessingSettings* class objects for processing modules are obtained via the respective [Settings](https://odea-project.github.io/StreamFind/reference/index.html#processing-settings-for-ms-data) functions. Below we obtain the *ProcessingSettings* for the module `find_features()` using the algorithm *xcms3_centwave*. The parameters for each processing module can be changed via the function arguments and the information about the meaning of each parameter can be found in the [StreamFind reference documentation](https://odea-project.github.io/StreamFind/reference/index.html).

```{r ffs, results='markup'}
# Get ProcessingSettings for finding features using the xcms3 centwave algorithm
ffs <- Settings_find_features_xcms3_centwave()

# Print in console the details of the ProcessingSettings
ffs
```

```{r other-settings, results='markup'}
fls <- Settings_filter_features_StreamFind(
  minIntensity = 5000,
  minSnRatio = 20,
  maxGroupSd = 30,
  blank = 5,
  minGroupAbundance = 3,
  excludeIsotopes = TRUE
)

fls

afs <- Settings_annotate_features_StreamFind()

afs

gfs <- Settings_group_features_xcms3_peakdensity()

gfs
```

## Add *ProcessingSettings*

When all settings are available, they can be added or used directly to run the workflow. In the example below, the different *ProcessingSettings* are first added to the *MassSpecData* in the desired order.

```{r add-settings, results='markup'}
# Add settings for finding, annotating, grouping and finally filter features
ms$add_settings(settings = list(ffs, afs, gfs, fls))

# Getting the workflow settings
ms$get_settings_names()
```

## Apply the workflow

The modules assidadded *ProcessingSettings* can be processed by `run_workflow()` as demonstrated below or by chaining all the modules. With `run_workflow()`, the processing modules are applied with the same order they were added. By chaining the order can be modified as the modules are individually called, as shown below.

```{r do-workflow, results='markup', warning=FALSE}
# Run all ProcessingSettings added to the MassSpecData
ms$run_workflow()
```

```{r do-workflow-chain, eval=FALSE}
# Alternatively, the modules can be chained
ms$find_features()$annotate_features()$group_features()$filter_features()
```

***

<!-- <style> -->
<!-- body, p { -->
<!--   color: black; -->
<!--   font-family: Arial; -->
<!--   text-align: justify; -->
<!--   font-size: 12pt; -->
<!-- } -->
<!-- h1{ -->
<!--   font-size: 20pt; -->
<!--   font-style: bold; -->
<!-- } -->
<!-- h2{ -->
<!--   font-size:18pt; -->
<!--   font-style: bold; -->
<!-- } -->
<!-- h3{ -->
<!--   font-size:14pt; -->
<!--   font-style: bold; -->
<!-- } -->
<!-- .list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover { -->
<!--     background-color: #177013; -->
<!-- } -->
<!-- caption { -->
<!--   color: black; -->
<!--   font-size: 1.0em; -->
<!-- } -->
<!-- </style> -->
