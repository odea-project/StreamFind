---
title: 'Detection of quality deviations in paracetamol products'
subtitle: |
  | Fusion of Mass Spectrometry and Raman Spectroscopy Data
  | <br>
author:
  name: Ricardo Cunha
  email: cunha@iuta.de
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: true
    toc: true
    number_sections: true
    toc_float: true
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Fusion of Mass Spectrometry and Raman Spectroscopy Data}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(magrittr)
library(ggplot2)
library(plotly)
library(data.table)
library(StreamFind)

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 9, results = "markup", comment = "")

#main_dir <- "E:/iSoft/Paracetamol" # StreamFind Workstation
main_dir <- "C:/Users/apoli/Documents/iSoft/Paracetamol" # Ricardo laptop

raman_dir <- paste0(main_dir, "/raman")
raman_dir_extra <- paste0(main_dir, "/raman/extra")
raman_files <- list.files(raman_dir, pattern = ".asc", full.names = TRUE)
raman_files_extra <- list.files(raman_dir_extra, pattern = ".asc", full.names = TRUE)
raman_files <- c(raman_files, raman_files_extra)
names(raman_files) <- basename(raman_files)
raman_files <- raman_files[sort(basename(raman_files))]
#data.frame("file" = basename(raman_files), "path" = raman_files, row.names = NULL)
raman_files <- raman_files[c(19:27, 28:36, 73:81, 155:157, 161:205)]
```

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<br>

<br>

***

This article demonstrates how StreamFind can be used to quantity the active product ingredient (API) in Fizamol (i.e., 
paracetamol) from Raman data. 
A calibration curve is acquired with pure paracetamol diluted in water at different concentrations.

```{r raman-setup}
# Creates the engine for Raman data
raman <- RamanEngine$new(analyses = raman_files)

# Modifies the replicates names
raman$analyses$replicates <- c(
  rep("blank", 9),
  rep("fiz_a", 9),
  rep("fiz_b", 9),
  rep("par_3", 3),
  rep("cali_150_mgml", 9),
  rep("cali_010_mgml", 9),
  rep("cali_025_mgml", 9),
  rep("cali_050_mgml", 9),
  rep("cali_075_mgml", 9)
)

# Modifies the blanks names
raman$analyses$blanks <- c(rep("blank", length(raman$analyses)))
```

<br>

<br>

```{r raman-overview, echo=FALSE}
ov_quant <- raman$get_overview()[, 1:3]
data.table::setorder(ov_quant, replicate)
ov_quant$concentration <- as.numeric(c(rep(0, 9), sub(".*?(\\d+).*", "\\1", ov_quant$replicate[10:nrow(ov_quant)]))) / 10
ov_quant$concentration[ov_quant$replicate %in% "par_3"] <- NA_real_
kable(ov_quant, caption = "Overview of Raman analyses and respective analysis replicate groups and blanks.") %>%
  kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed", "responsive"), fixed_thead = TRUE) %>%
  scroll_box(width = "100%", height = "400px")
```

<br>

<br>

# Pre-processing

The data is pre-processed using StreamFind's built-in data dedicated engines for MS and Raman data. Pre-processing workflows for each data type are executed before data fusion to improve statistic analysis.

```{r plot-raman-conc-raw, fig.cap="Raw averaged Raman spectra for each analysis replicate."}
raman$plot_spectra(colorBy = "replicates")
```

```{r raman-conc-workflow}
raman_workflow_settings <- list(
  RamanSettings_AverageSpectra_StreamFind(),
  RamanSettings_SubtractBlankSpectra_StreamFind(),
  RamanSettings_SmoothSpectra_savgol(fl = 21, forder = 4, dorder = 0),
  RamanSettings_DeleteSpectraSection_StreamFind(list("shift" = c(-100, 350))),
  RamanSettings_DeleteSpectraSection_StreamFind(list("shift" = c(1800, 2500))),
  RamanSettings_CorrectSpectraBaseline_airpls(lambda = 45, differences = 1, itermax = 30)
)

raman$workflow <- StreamFind::Workflow(raman_workflow_settings)

raman$print_workflow()
```

```{r raman-conc-run-workflow}
raman$run_workflow()
```

```{r plot-raman-conc-spectra, fig.cap="Pre-processed Raman spectra for analysis replicate."}
raman$plot_spectra()
```

## Applying MCR-ALS

The quantification of paracetamol from the Raman spectra is performed using the Multivariate Curve Resolution (MCR) with Alternating Least Squares (ALS) method via integration of the [mdatools](https://mdatools.com/docs/mcr--als.html) R package.

```{r mcrals-show}
stat <- StatisticEngine$new(analyses = raman$get_spectra_matrix())
stat$run(StatisticSettings_MakeModel_mcrals_mdatools(ncomp = 2))
```

```{r mcrals-resolved-spec, fig.cap="Overview plot for the MCR-ALS model"}
plot(stat$model)
```

```{r}
stat$run(StatisticSettings_Quantify_mcrals(concentrations = c(1, 2.5, 5.0, 7.5, 15.0, NA_real_, NA_real_, NA_real_))) # concentrations with NA for unknown
```

```{r}
stat$quantification@quantities
```
