---
title: 'Detection of quality deviations in paracetamol products'
subtitle: |
  | Fusion of Mass Spectrometry and Raman Spectroscopy Data
  | <br>
author:
  name: Ricardo Cunha
  email: cunha@iuta.de
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: true
    toc: true
    number_sections: true
    toc_float: true
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Fusion of Mass Spectrometry and Raman Spectroscopy Data}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(magrittr)
library(ggplot2)
library(plotly)
library(data.table)
library(StreamFind)

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 9, results = "markup", comment = "")

#main_dir <- "E:/iSoft/Paracetamol" # StreamFind Workstation
main_dir <- "C:/Users/apoli/Documents/iSoft/Paracetamol" # Ricardo laptop

raman_dir <- paste0(main_dir, "/raman")
raman_dir_extra <- paste0(main_dir, "/raman/extra")
raman_files <- list.files(raman_dir, pattern = ".asc", full.names = TRUE)
raman_files_extra <- list.files(raman_dir_extra, pattern = ".asc", full.names = TRUE)
```

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<br>

<br>

***

This article demonstrates how StreamFind can be used to assess quality deviations of Fizamol paracetamol products using Mass Spectrometry (MS) combined with Raman Spectroscopy data. Each product was measured with MS and Raman. The data is pre-processed and fused to be used in unsupervised and supervised statistical analysis. Finally, the quality of the products is evaluated based on the statistical analysis. The quantity of paracetamol in the products is also estimated via statistic analysis.

```{r raman-setup, include=FALSE}
raman <- RamanEngine$new(analyses = c(raman_files, raman_files_extra))

raman$analyses$replicates <- c(
  rep("ass_1", 3),
  rep("ass_2", 3),
  rep("ass_3", 3),
  rep("caff_1", 3),
  rep("caff_2", 3),
  rep("caff_3", 3),
  rep("blank", 9),
  rep("fiz_c1", 3),
  rep("fiz_c2", 3),
  rep("fiz_c3", 3),
  rep("fiz_ass_n_1", 3),
  rep("fiz_ass_n_2", 3),
  rep("fiz_ass_n_3", 3),
  rep("fiz_ass1", 3),
  rep("fiz_ass2", 3),
  rep("fiz_ass3", 3),
  rep("fiz_caff1", 3),
  rep("fiz_caff2", 3),
  rep("fiz_caff3", 3),
  rep("fiz_a1", 3),
  rep("fiz_a2", 3),
  rep("fiz_a3", 3),
  rep("fiz_d1", 3),
  rep("fiz_d2", 3),
  rep("fiz_d3", 3),
  rep("fiz_b1", 3),
  rep("fiz_b2", 3),
  rep("fiz_b3", 3),
  rep("background", 4),
  rep("blank_e", 9),
  rep("fiz_acid1", 3),
  rep("fiz_acid2", 3),
  rep("fiz_acid3", 3),
  rep("fiz_e01", 3),
  rep("fiz_e02", 3),
  rep("fiz_e03", 3),
  rep("fiz_e04", 3),
  rep("fiz_e05", 3),
  rep("fiz_e06", 3),
  rep("fiz_e07", 3),
  rep("fiz_e08", 3),
  rep("fiz_e09", 3),
  rep("fiz_e10", 3),
  rep("fiz_e11", 3),
  rep("fiz_e12", 3),
  rep("par_1", 3),
  rep("par_odd", 3),
  rep("par_3", 3),
  rep("par_2", 3),
  rep("cali_150_mgml", 9),
  rep("cali_010_mgml", 9),
  rep("cali_025_mgml", 9),
  rep("cali_050_mgml", 9),
  rep("cali_075_mgml", 9),
  rep("background", 4)
)

raman$analyses <- raman$analyses[c(19:27, 161:205, 155:157)]
raman$analyses$blanks <- c(rep("blank", 57))
```

```{r raman-overview, echo=FALSE}
ov_quant <- raman$get_overview()[, 1:3]
data.table::setorder(ov_quant, replicate)
ov_quant$concentration <- as.numeric(c(rep(0, 9), sub(".*?(\\d+).*", "\\1", ov_quant$replicate[10:nrow(ov_quant)]))) / 10
ov_quant$concentration[ov_quant$replicate %in% "par_3"] <- NA_real_
kable(ov_quant, caption = "Overview of Raman analyses and respective analysis replicate groups and blanks.") %>%
  kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed", "responsive"), fixed_thead = TRUE) %>%
  scroll_box(width = "100%", height = "400px")
```

# Pre-processing

The data is pre-processed using StreamFind's built-in data dedicated engines for MS and Raman data. Pre-processing workflows for each data type are executed before data fusion to improve statistic analysis.

```{r plot-raman-conc-raw, fig.cap="Raw averaged Raman spectra for each analysis replicate."}
raman$plot_spectra(colorBy = "replicates")
```

```{r raman-conc-workflow}
raman_workflow_settings <- list(
  RamanSettings_AverageSpectra_StreamFind(),
  RamanSettings_SubtractBlankSpectra_StreamFind(),
  RamanSettings_SmoothSpectra_savgol(fl = 21, forder = 4, dorder = 0),
  RamanSettings_DeleteSpectraSection_StreamFind(list("shift" = c(-100, 350))),
  RamanSettings_DeleteSpectraSection_StreamFind(list("shift" = c(1800, 2500))),
  RamanSettings_CorrectSpectraBaseline_airpls(lambda = 45, differences = 1, itermax = 30)
)

raman$workflow <- StreamFind::Workflow(raman_workflow_settings)

raman$print_workflow()
```

```{r raman-conc-run-workflow}
raman$run_workflow()
```

```{r plot-raman-conc-spectra, fig.cap="Pre-processed Raman spectra for analysis replicate."}
raman$plot_spectra()
```

## Applying MCR-ALS

The quantification of paracetamol from the Raman spectra is performed using the Multivariate Curve Resolution (MCR) with Alternating Least Squares (ALS) method via integration of the [mdatools](https://mdatools.com/docs/mcr--als.html) R package.

```{r mcrals-show}
stat3 <- StatisticEngine$new(analyses = raman$get_spectra_matrix())
stat3$add_concentrations(c(1, 2.5, 5.0, 7.5, 15.0, NA_real_)) # add concentrations, with NA for unknown
stat3$run(StatisticSettings_MakeModel_mcrals_mdatools(ncomp = 3))


plot_contributions(stat3$model)

#plot_resolved_spectra(stat3$model)
#plot_explained_variance(stat3$model)
#plot(stat3$model)
#get_model_data(stat3$model)
#summary(stat3$model)
```

```{r}
get_model_data(stat3$model)
```

```{r mcrals-resolved-spec, fig.cap="Resolved spectra for each component and the spectra for each analysis replicate (i.e., each concentration)."}
stat3$plot_resolved_spectra()
```

```{r mcrals-cont, fig.cap="Contributions for each analysis replicate."}
stat3$plot_model_contributions()
```

The `quantify` method can be used to estimate the concentration of the paracetamol analyses with unknown concentration. The quantification is applied to each component, returning a list with the r square of the linear model and the estimated concentration as `data.table`. Note that the explained variance for each component is important to evaluate the calculated concentration. The best estimation is from the component with the combined explained variance and r square closer to 100 and 1, respectively.

```{r}
stat3$quantify()
```
